import re
import time

from API1 import address_to_coordinate

# 원본 주소 리스트 (중복 제거)
fails = list(
    set(
        [
            "경기도 가평군 가평읍 보납로74번길 6-4",
            "경기도 고양시 덕양구 오부자로 1길 18, 1층",
            "경기도 광주시 곤지암읍 경충대로 1461번길 43",
            "경기도 광주시 오포읍 능평로 101",
            "경기도 광주시 오포읍 능평로 180",
            "경기도 광주시 오포읍 능평로 194-13",
            "경기도 광주시 오포읍 능평로 201",
            "경기도 광주시 오포읍 능평로 46-14",
            "경기도 광주시 오포읍 능평로 63",
            "경기도 광주시 오포읍 능평로 94",
            "경기도 광주시 오포읍 대명대길 18-3",
            "경기도 광주시 오포읍 마루들길 224-1",
            "경기도 광주시 오포읍 마루들길 227",
            "경기도 광주시 오포읍 마루들길 228",
            "경기도 광주시 오포읍 마루들길 231-22",
            "경기도 광주시 오포읍 마루들길 238-7",
            "경기도 광주시 오포읍 마루들길 246",
            "경기도 광주시 오포읍 마루들길 247",
            "경기도 광주시 오포읍 마루들길 253-6",
            "경기도 광주시 오포읍 마루들길 259-1",
            "경기도 광주시 오포읍 문형산길 19",
            "경기도 광주시 오포읍 문형산길 21",
            "경기도 광주시 오포읍 문형산길 25",
            "경기도 광주시 오포읍 문형산길 27",
            "경기도 광주시 오포읍 상태길 16",
            "경기도 광주시 오포읍 상태길 41-11",
            "경기도 광주시 오포읍 상태길 63",
            "경기도 광주시 오포읍 상태길 73-42",
            "경기도 광주시 오포읍 상태길 73-72",
            "경기도 광주시 오포읍 새말길 24",
            "경기도 광주시 오포읍 새말길 61",
            "경기도 광주시 오포읍 새말길 73",
            "경기도 광주시 오포읍 새말길167번길 13",
            "경기도 광주시 오포읍 수레실길 25-3",
            "경기도 광주시 오포읍 수레실길 5",
            "경기도 광주시 오포읍 수레실길 71",
            "경기도 광주시 오포읍 신현로 104-3",
            "경기도 광주시 오포읍 신현로 12-74",
            "경기도 광주시 오포읍 신현로 120",
            "경기도 광주시 오포읍 신현로 121",
            "경기도 광주시 오포읍 신현로 122",
            "경기도 광주시 오포읍 신현로 124",
            "경기도 광주시 오포읍 신현로 125-1",
            "경기도 광주시 오포읍 신현로 48",
            "경기도 광주시 오포읍 신현로 74",
            "경기도 광주시 오포읍 신현로12번길 13",
            "경기도 광주시 오포읍 양벌로 194",
            "경기도 광주시 오포읍 양벌로 195-30",
            "경기도 광주시 오포읍 양벌로 195-4",
            "경기도 광주시 오포읍 양벌로 195-40",
            "경기도 광주시 오포읍 양벌로 195-8",
            "경기도 광주시 오포읍 양벌로 197",
            "경기도 광주시 오포읍 양벌로 295",
            "경기도 광주시 오포읍 양벌로 299",
            "경기도 광주시 오포읍 양벌로 303-10",
            "경기도 광주시 오포읍 양벌로 303-12",
            "경기도 광주시 오포읍 양벌로 303-13",
            "경기도 광주시 오포읍 양벌로 303-16",
            "경기도 광주시 오포읍 양벌로 303-3",
            "경기도 광주시 오포읍 양벌로 303-4",
            "경기도 광주시 오포읍 양벌로 303-6",
            "경기도 광주시 오포읍 양촌길 133-3",
            "경기도 광주시 오포읍 양촌길 133-4",
            "경기도 광주시 오포읍 양촌길 139",
            "경기도 광주시 오포읍 양촌길 141",
            "경기도 광주시 오포읍 양촌길 146-13",
            "경기도 광주시 오포읍 양촌길 156",
            "경기도 광주시 오포읍 양촌길 159",
            "경기도 광주시 오포읍 양촌길 162",
            "경기도 광주시 오포읍 양촌안길 35-4",
            "경기도 광주시 오포읍 양촌안길 38",
            "경기도 광주시 오포읍 양촌안길 43-1",
            "경기도 광주시 오포읍 양촌안길 44-5",
            "경기도 광주시 오포읍 오포안로 263",
            "경기도 광주시 오포읍 오포안로 270",
            "경기도 광주시 오포읍 오포안로 272",
            "경기도 광주시 오포읍 왕림로 43",
            "경기도 광주시 오포읍 창뜰윗길6번길 10",
            "경기도 광주시 오포읍 추자길 17",
            "경기도 광주시 오포읍 추자길 27",
            "경기도 광주시 오포읍 추자길 6",
            "경기도 광주시 오포읍 태재로 103",
            "경기도 광주시 오포읍 태재로 137-3",
            "경기도 광주시 오포읍 태재로 20-7",
            "경기도 광주시 오포읍 태재로 22",
            "경기도 광주시 오포읍 회안대로 99",
            "경기도 김포시 김포한강2로 104-4",
            "경기도 김포시 양촌면 양곡1로 66",
            "경기도 김포시 양촌면 양곡1로56번길 73",
            "경기도 김포시 조리미로 39-36",
            "경기도 남양주시 오남읍 진건오남로 510",
            "경기도 남양주시 진건읍 다산순환로 325",
            "경기도 남양주시 퇴계원면 경춘북로 535",
            "경기도 남양주시 퇴계원면 경춘북로558번길 12",
            "경기도 남양주시 퇴계원면 경춘북로558번길 9",
            "경기도 남양주시 퇴계원면 도제원로 19",
            "경기도 남양주시 퇴계원면 도제원로 2",
            "경기도 남양주시 퇴계원면 도제원로 20",
            "경기도 남양주시 퇴계원면 도제원로 31",
            "경기도 남양주시 퇴계원면 도제원로 63",
            "경기도 남양주시 퇴계원면 퇴계원로 29",
            "경기도 남양주시 퇴계원면 퇴계원로 83",
            "경기도 남양주시 퇴계원면 퇴계원로 83-1",
            "경기도 남양주시 퇴계원면 퇴계원로 87",
            "경기도 남양주시 퇴계원면 퇴계원로46번길 10",
            "경기도 남양주시 퇴계원면 퇴계원로50번길 10",
        ]
    )
)

# 정렬
fails.sort()


def apply_fallback(address: str) -> list[tuple[str, str]]:
    """
    Fallback 로직을 적용하여 시도할 주소 변형들을 반환

    Returns:
        [(변형된 주소, 적용된 규칙), ...]
    """
    variants = [(address, "원본")]

    # 1. 퇴계원면 -> 퇴계원읍
    if "퇴계원면" in address:
        variants.append((address.replace("퇴계원면", "퇴계원읍"), "퇴계원면→읍"))

    # 2. 오포읍 + 도로명(~로, ~길) -> 능평리로 변환 시도는 의미 없음
    #    도로명주소를 지번주소로 바꾸는 건 불가능
    #    대신 "오포읍" 제거 시도

    # 3. 읍/면/구 제거 fallback
    # ~~읍, ~~면, ~~구 단어 제거
    addr_no_eup = re.sub(r"\s+\S+읍\s+", " ", address)
    if addr_no_eup != address:
        variants.append((addr_no_eup.strip(), "읍 제거"))

    addr_no_myeon = re.sub(r"\s+\S+면\s+", " ", address)
    if addr_no_myeon != address:
        variants.append((addr_no_myeon.strip(), "면 제거"))

    addr_no_gu = re.sub(r"\s+\S+구\s+", " ", address)
    if addr_no_gu != address:
        variants.append((addr_no_gu.strip(), "구 제거"))

    return variants


def test_address(address: str) -> tuple[str, str, float | None, float | None]:
    """
    주소를 테스트하고 결과 반환

    Returns:
        (성공한 주소, 적용된 규칙, 경도, 위도) 또는 (원본, "실패", None, None)
    """
    variants = apply_fallback(address)

    for variant_addr, rule in variants:
        result = address_to_coordinate(variant_addr, addr_type="ROAD")
        if result:
            return variant_addr, rule, result[0], result[1]
        time.sleep(0.05)

    return address, "실패", None, None


def main():
    print("=" * 90)
    print("도로명주소 Fallback 로직 테스트")
    print(f"총 {len(fails)}개 고유 주소")
    print("=" * 90)

    success_count = 0
    fail_count = 0
    rule_stats = {}

    results = []

    for i, addr in enumerate(fails, 1):
        print(f"\n[{i}/{len(fails)}] {addr}")

        matched_addr, rule, x, y = test_address(addr)

        if x is not None:
            print(f"  ✓ [{rule}] → ({x}, {y})")
            success_count += 1
            rule_stats[rule] = rule_stats.get(rule, 0) + 1
        else:
            print(f"  ✗ 실패")
            fail_count += 1

        results.append(
            {
                "원본": addr,
                "변형": matched_addr,
                "규칙": rule,
                "경도": x,
                "위도": y,
            }
        )

        time.sleep(0.05)

    # 결과 요약
    print("\n" + "=" * 90)
    print("결과 요약")
    print("=" * 90)
    print(f"  총 주소: {len(fails)}개")
    print(f"  성공: {success_count}개 ({100*success_count/len(fails):.1f}%)")
    print(f"  실패: {fail_count}개 ({100*fail_count/len(fails):.1f}%)")

    print("\n[규칙별 성공 횟수]")
    for rule, count in sorted(rule_stats.items(), key=lambda x: -x[1]):
        print(f"  {rule}: {count}개")

    # 실패 목록
    failed_list = [r for r in results if r["규칙"] == "실패"]
    if failed_list:
        print(f"\n[실패한 주소 ({len(failed_list)}개)]")
        print("-" * 90)
        for r in failed_list:
            print(f"  {r['원본']}")


if __name__ == "__main__":
    main()
